<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title></title>
    <script src="../vendor/jquery/jquery.min.js"></script>
    <script src="../vendor/hashmap/hashmap.js"></script>
    <script src="../lib/class.js"></script>
    <script src="../tests/sample-data.js"></script>
    <script src="../lib/inspect.js"></script>

    <script src="../lib/amf/dataview.js"></script>
    <script src="../lib/amf/base.js"></script>
    <script src="../lib/amf/events.js"></script>
    <script src="../lib/amf/bufferstream.js"></script>
    <script src="../lib/amf/objects.js"></script>
    <script src="../lib/amf/dict.js"></script>
    <script src="../lib/amf/traits-info.js"></script>
    <script src="../lib/amf/connection.js"></script>
    <script src="../lib/amf/amf3/encoder.js"></script>
    <script src="../lib/amf/amf3/decoder.js"></script>
    
    <script type="text/javascript">
        (function () {

            var base = "http://localhost.dev/projects/amf.js/server.php";
            var url = base;

            var serialize = function (data) {
                var o = new amf._BufferOutputStream();
                new amf.AMF3Encoder(o, true).encode(data);

                var buf = new ArrayBuffer(o.size);
                o.writeTo(buf);
                return buf;
            };

            var deserialize = function (data) {
                var input = new amf._BufferInputStream(data);

                var data = new amf.AMF3Decoder(input).decode();
                return data;
            };

            var call = function (url, data) {
                var xhr = new XMLHttpRequest();
                xhr.addEventListener("load", function (event) {
                    var xhr = event.currentTarget;
                    var input = new amf._BufferInputStream(amf.readBufferFromXHR(xhr));
                    var data = new amf.AMF3Decoder(input).decode();
                    console.log(">>>", data);

//                    console.log(input.readBytes(input.byteLength - 1));
//                    console.log(xhr.response, deserialize(xhr.response), deserialize(amf.readBufferFromXHR(xhr)));
                }, false);
                xhr.addEventListener("error", future, false);

                xhr.open("POST", url, true);
                xhr.setRequestHeader("Content-Type", "application/x-amf");
                xhr.overrideMimeType("text/plain; charset=x-user-defined");
                xhr.responseType = "arraybuffer";

                xhr.send(data);
            };

            for (var i in tests) {
                console.log('sending', tests[i][1]);
                var s = serialize({packet: tests[i][1] });
//                console.log(deserialize(s));
                url = base + "?target=" + inspect(tests[i][1]).substr(0, 200);

                call(url, s);
            }


//            send the whole fucker
//            call(url, serialize({data: tests, biggun: true}));

            return;

            var connection = new amf.AMFConnection(url, 3);
            connection.addEventListener("fault", function (event) {
                log(event.cause);
                event.stopPropagation();
            }, true);
            connection.onerror = function (event) {
                log(event.cause);
            }

            var future = connection.execute("RoundtripService.sum", [1, 2]);
            future.onresult = function (event) {
                alert("1 + 2 = " + event.result);
            }

            var solipsism = {
                name: 'Danny'
            };
            solipsism.known = solipsism;

            /***
             *
             * FIND WAY OF DESERIALIZING DATA FAITHFULLY FOR CIRCULAR REFS
             *
             *
             *
             * @param event
             */

            connection.execute("RoundtripService.complex", [solipsism]).onresult = function (event) {
                debugger;
//                alert(event.result + " from server!");
            }
        })();
    </script>
</head>
<body>

</body>
</html>