<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title></title>
    <script src="../vendor/jquery/jquery.min.js"></script>
    <!--<script src="../lib/amf.js"></script>-->
    <!--<script src="../lib/binary.js"></script>-->
    <script src="../vendor/hashmap/hashmap.js"></script>
    <script src="../lib/inspect.js"></script>
    <script src="../lib/alt.js"></script>
    <script src="../lib/amf.js"></script>


    <script type="text/javascript">
        (function () {

            var base = "http://localhost.dev/projects/amf.js/server.php";
            var url = base;

            var serialize = function (data) {
                var o = new amf._BufferOutputStream();
                new amf.AMF3Encoder(o, true).encode(data);

                var buf = new ArrayBuffer(o.size);
                o.writeTo(buf);
                return buf;
            };

            var deserialize = function (data) {
                var input = new amf._BufferInputStream(data);

                var data = new amf.AMF3Decoder(input).decode();
                return data;
            };

            var call = function (url, data) {
                var xhr = new XMLHttpRequest();
                xhr.addEventListener("load", function(event) {
                    var xhr = event.currentTarget;
                    var input = new amf._BufferInputStream(amf.readBufferFromXHR(xhr));
                    var data = new amf.AMF3Decoder(input).decode();
                    console.log(">>>", data);

//                    console.log(input.readBytes(input.byteLength - 1));
//                    console.log(xhr.response, deserialize(xhr.response), deserialize(amf.readBufferFromXHR(xhr)));
                }, false);
                xhr.addEventListener("error", future, false);

                xhr.open("POST", url, true);
                xhr.setRequestHeader("Content-Type", "application/x-amf");
                xhr.overrideMimeType("text/plain; charset=x-user-defined");
                xhr.responseType = "arraybuffer";

                xhr.send(data);
            };

            var guy = {name: 'Danny'};
            var bro = {name: 'Brad'};
            var siblings = [guy, bro];
            guy.siblings = siblings;

            var tests = [
                // strings
                ['empty string', ''],
                ['ascii string', 'Hello World'],
                ['unicode string', '£今\u4ECA"\u65E5日'],
                // numbers
                ['zero', 0 ],
                ['integer in 1 byte u29 range', 0x7F ],
                ['integer in 2 byte u29 range', 0x00003FFF ],
                ['integer in 3 byte u29 range', 0x001FFFFF ],
                ['integer in 4 byte u29 range', 0x1FFFFFFF ],
                ['large integer', 4294967296 ],
                ['large negative integer', -4294967296 ],
                ['small negative integer', -1 ],
                ['medium negative integer', -1956 ],
                ['small floating point', 0.123456789 ],
                ['small negative floating point', -0.987654321 ],
                ['Number.MIN_VALUE', Number.MIN_VALUE ],
                ['Number.MAX_VALUE', Number.MAX_VALUE ],
                ['Number.POSITIVE_INFINITY', Number.POSITIVE_INFINITY ],
                ['Number.NEGATIVE_INFINITY', Number.NEGATIVE_INFINITY ],
                ['Number.NaN', Number.NaN],
                // other scalars
                ['Boolean false', false],
                ['Boolean true', true ],
                ['undefined', undefined ],
                ['null', null],
                // Arrays
                ['empty array', [] ],
                ['sparse array', [undefined, undefined, undefined, undefined, undefined, undefined] ],
                ['multi-dimensional array', [
                    [
                        [],
                        []
                    ],
                    []
                ] ],
                // special objects
                ['date object (epoch)', new Date(0) ],
                ['date object (now)', new Date() ],
                // plain objects
                ['empty object', {} ],
                ['keyed object', { foo: 'bar', 'foo bar': 'baz' } ],
                ['circular object', guy ]
            ];

            var rand = '';
            for(var i = 0; i < 1024 * 1024; i++) {
                rand += String.fromCharCode(65);
            }

            tests.push(['large string', rand]);

            for (var i in tests) {
                console.log('sending', tests[i][1]);
                var s = serialize( {packet: tests[i][1] } );
//                console.log(deserialize(s));
                url = base + "?target=" + inspect(tests[i][1]).substr(0, 200);

                call(url, s);
            }



//            send the whole fucker
//            call(url, serialize({data: tests, biggun: true}));

            return;

            var connection = new amf.AMFConnection(url, 3);
            connection.addEventListener("fault", function (event) {
                log(event.cause);
                event.stopPropagation();
            }, true);
            connection.onerror = function (event) {
                log(event.cause);
            }

            var future = connection.execute("RoundtripService.sum", [1, 2]);
            future.onresult = function (event) {
                alert("1 + 2 = " + event.result);
            }

            var solipsism = {
                name: 'Danny'
            };
            solipsism.known = solipsism;

            /***
             *
             * FIND WAY OF DESERIALIZING DATA FAITHFULLY FOR CIRCULAR REFS
             *
             *
             *
             * @param event
             */

            connection.execute("RoundtripService.complex", [solipsism]).onresult = function (event) {
                debugger;
//                alert(event.result + " from server!");
            }
        })();
    </script>
</head>
<body>

</body>
</html>